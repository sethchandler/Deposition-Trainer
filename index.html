<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seth Chandler's Deposition Trainer</title>
    <style>
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #1c1e21;
            --label-color: #606770;
            --border-color: #ced0d4;
            --input-background: #f5f6f7;
            --button-background: #1877f2;
            --button-text-color: #ffffff;
            --user-bubble-background: #0084ff;
            --assistant-bubble-background: #e4e6eb;
            --meta-bubble-background: #fffbe6;
            --meta-bubble-border: #ffe58f;
            --disabled-color: #bec3c9;
            --toggle-on-color: #1877f2;  /* Blue for Coach */
            --toggle-off-color: #28a745; /* Green for Witness */
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 680px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--label-color);
            margin-bottom: 6px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--input-background);
            font-size: 16px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-group input[type="file"] {
            background-color: transparent;
            padding: 8px 0;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }
        .button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            background-color: var(--button-background);
            color: var(--button-text-color);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .button-secondary {
            background-color: #e4e6eb;
            color: #050505;
            font-size: 14px;
            padding: 6px 12px;
        }
        .button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }
        #chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 16px;
            background-color: #fff;
        }
        .message-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .user-message {
            background-color: var(--user-bubble-background);
            color: white;
            align-self: flex-end;
        }
        .assistant-message {
            background-color: var(--assistant-bubble-background);
            color: #050505;
            align-self: flex-start;
        }
        .meta-message {
            background-color: var(--meta-bubble-background);
            border: 1px solid var(--meta-bubble-border);
            color: #573a00;
            align-self: stretch;
            max-width: 100%;
        }
        .typing-indicator {
            padding: 8px 12px;
            font-style: italic;
            color: var(--label-color);
        }
        #chat-input-area {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        #chatInput {
            flex-grow: 1;
            resize: none;
            overflow-y: hidden;
            line-height: 1.5;
            font-size: 17px;
        }
        #chat-input-area #sendButton {
            width: auto;
            padding: 0 20px;
            height: 46px;
        }
        .app-header {
            text-align: center;
        }
        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 8px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off-color);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--toggle-on-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        #cost-details {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            color: var(--label-color);
            background-color: var(--input-background);
            padding: 10px;
            border-radius: 6px;
        }
        #cost-details p {
            margin: 0;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .summary-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px;
        }
        .summary-slider:hover {
            opacity: 1;
        }
        .summary-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--button-background);
            cursor: pointer;
            border-radius: 50%;
        }
        .summary-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--button-background);
            cursor: pointer;
            border-radius: 50%;
        }
        .divider {
            text-align: center;
            margin: 10px 0;
            color: var(--label-color);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="app-header">
            <h1 style="font-size: 28px; margin: 0 0 4px 0;">Seth Chandler's Deposition Trainer</h1>
            <p style="font-size: 16px; color: var(--label-color); margin: 0;">The complete deposition simulation tool.</p>
        </div>

        <div class="card">
            <h2 class="card-title">1. LLM & Deposition Settings</h2>
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider"></select>
            </div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="Paste your key here">
            </div>
            <div class="form-group">
                <label for="model">Model</label>
                <select id="model"></select>
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="judgeMode">
                <label for="judgeMode">A Judge is present to rule on objections.</label>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">2. Choose a Scenario</h2>
            <div class="form-group">
                <label>Start with a Pre-Built Scenario</label>
                <select id="scenarioSelector">
                    <option value="-1" disabled selected>Select a case...</option>
                    <option value="0">Homicide Case: The Eyewitness with a Secret</option>
                    <option value="1">Domestic Violence Case: The Observant Neighbor</option>
                    <option value="2">Employment Case: The HR Manager</option>
                </select>
            </div>
            <p class="divider">OR</p>
            <div class="form-group">
                <label for="fileLoader">Upload Your Own Case File (.json)</label>
                <input type="file" id="fileLoader" accept=".json">
            </div>
        </div>
        
        <div class="card" id="witnessSelectorCard" style="display: none;">
            <h2 class="card-title">3. Select Witness</h2>
            <div class="form-group">
                <select id="witnessSelector"></select>
            </div>
        </div>
        
        <div class="card" id="intelCard" style="display: none;">
            <h2 class="card-title">4. Pre-Deposition Intel</h2>
            <div class="form-group">
                <label for="summaryDetailSlider">Summary Detail Level</label>
                <div class="slider-container">
                    <span>Minimal</span>
                    <input type="range" min="1" max="3" value="2" class="summary-slider" id="summaryDetailSlider">
                    <span>Maximal</span>
                </div>
            </div>
            <button id="getSummaryButton" class="button">Get Witness Summary</button>
        </div>

        <div class="card" id="costTrackerCard">
            <h2 class="card-title" style="margin-bottom: 10px;">Session Usage & Cost Estimate</h2>
            <div id="cost-details">
                <p><strong>Total Tokens:</strong> <span id="totalTokens">0</span></p>
                <p><strong>Estimated Cost:</strong> <span id="estimatedCost">$0.000000</span></p>
            </div>
        </div>

        <div class="card" id="chat-window">
            <div class="card-header">
                <h2 class="card-title" id="chat-title">Deposition</h2>
                <button id="saveTranscriptButton" class="button button-secondary" disabled>Save Transcript</button>
            </div>
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <div class="toggle-switch-container">
                    <span>Witness</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeToggleCheckbox">
                        <span class="slider"></span>
                    </label>
                    <span>Coach</span>
                </div>
                <textarea id="chatInput" placeholder="Choose or upload a scenario to begin..." rows="2" disabled></textarea>
                <button id="sendButton" class="button" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PRE_BUILT_SCENARIOS = [
                { "witnessProfile": { "witnessId": "WS-2024-07-23-001", "caseReference": "Homicide-PKM-2024-031" }, "witnessBackground": { "personalDetails": { "fullName": "Johnathan 'John' Sterling", "age": 40, "occupation": "Vice President of Regional Sales, 'Texacorp Solutions'", "residence": "Memorial, Houston, TX" }, "professionalLife": { "reputation": "Highly respected, dependable, ethical, and family-oriented." }, "personalLifeAndRelationships": { "marriage": "Strained.", "affair": "Involved in a six-month affair with a junior colleague, 'Chloe'. Terrified of discovery." } }, "witnessMotivations": { "primaryMotivationToConceal": "Must protect the secret of his affair. He cannot place himself at the 'Starlight Motel' without inviting questions he cannot answer truthfully.", "strategyOfPartialDisclosure": "He will provide information about the perpetrator but will lie about his reason for being at the motel, claiming he pulled over to nap." }, "fullWitnessInformation": { "officialStatementSummary": "Witness claims he was driving home late from a 'client dinner', felt tired, and pulled into the motel lot to nap. From his car, he witnessed the incident.", "narrativeOfEvents": { "theIncident": "Heard a loud argument between two men. Watched the larger man stab the smaller man. The perpetrator's face was clearly visible in the light from the motel office window.", "theAftermath": "Paralyzed by fear of exposure, he did not call 911. He drove away and contacted police the next day via a tip line using a burner phone." }, "descriptionOfPerpetrator": { "physical": "White male, late 20s/early 30s, stocky build, short dark hair, with a prominent scar through his left eyebrow.", "confidenceLevel": "8/10, despite not wearing his prescription glasses for distance." }, "inconsistenciesAndEvasions": { "reasonForPresence": "The 'napping' story is a fabrication. He will become defensive if pressed.", "timeline": "He will be vague about the 'client dinner' to hide the two-hour gap when he was with his mistress.", "visualAcuity": "He will downplay his need for glasses." } } },
                { "witnessProfile": { "witnessId": "WS-2024-07-23-002", "caseReference": "Civil-DV-2024-047" }, "witnessBackground": { "personalDetails": { "fullName": "Margaret 'Maggie' Ruth Chen", "age": 52, "occupation": "Retired Elementary School Teacher", "residence": "Next door to the victim." }, "personalLifeAndRelationships": { "personalValues": "Strongly believes in protecting victims, a value from her teaching career. Grew up with an abusive father, making her sensitive to signs of abuse.", "conflictAvoidance": "Despite protective instincts, she is conflict-averse and fears direct confrontation." } }, "witnessMotivations": { "primaryMotivationToTestify": "Feels a moral obligation to speak the truth about what she witnessed.", "conflictingMotivationForSafety": "Genuinely afraid of retaliation from the perpetrator, Jay Dooley, whom she knows to be violent.", "documentation": "As a teacher, she kept a detailed, hidden journal with dates, times, and descriptions of incidents." }, "fullWitnessInformation": { "officialStatementSummary": "Witness states she observed multiple incidents of domestic violence, stalking, and harassment by Jay Dooley against her neighbor between April and December 2007.", "narrativeOfEvents": { "aprilKnifeIncident": "Witnessed Dooley hold a knife to his own throat and cut his wrist at the victim's front gate. She called 911.", "novemberAssault": "From her kitchen window, she had a clear view of Dooley violently assaulting the victim in the backyard for 15-20 minutes. She was too terrified to call the police during the assault.", "stalking": "Observed Dooley's vehicle watching the house at odd hours and following the victim's car." }, "descriptionOfPerpetrator": { "physical": "White male, approx. 35-40, medium to stocky build, brown hair, visible tattoos on both arms.", "confidenceLevel": "Very high (9/10) in her observations, which she documented in her journal." }, "inconsistenciesAndLimitations": { "regretOverInaction": "Feels tremendous guilt for not calling the police during the most severe assault in November." } } },
                { "witnessProfile": { "witnessId": "HRM-2025-07-23-003", "caseReference": "Clark v. Ener-Tek Solutions" }, "witnessBackground": { "personalDetails": { "fullName": "Susan Miller", "age": 48, "occupation": "Director of Human Resources, Ener-Tek Solutions", "residence": "The Woodlands, TX" }, "professionalLife": { "careerTrajectory": "20+ years in HR, 8 at Ener-Tek (a small Houston energy firm). Known for being firm, process-oriented, and a staunch defender of company policy.", "reputation": "Professional and efficient, but not warm. Seen as an enforcer of rules whose primary role is to protect the company from legal risk." } }, "witnessMotivations": { "primaryMotivation": "To defend her decision and the company. She genuinely believes the termination of the plaintiff, Dave Clark, was justified based on performance.", "keyConcealment": "Desperately wants to hide a 'stray remark' she made to a colleague a month before the firing: 'The real problem is that David Clark has just gotten old.' She knows this comment is legally toxic.", "strategy": "Stick to the official record: performance reviews, tardiness logs, etc. If asked about the remark, first deny or not recall. If pressed hard, admit it but frame it as a regrettable, out-of-context comment that had no bearing on the official, data-driven decision." }, "fullWitnessInformation": { "officialReasonForTermination": "Termination of Dave Clark (62, data analyst) was based on declining performance: 8 instances of tardiness last quarter, missed deadlines on two major projects, and an increase in errors in his reports.", "theStrayRemarkIncident": "Said 'the real problem is that David Clark has just gotten old' to the head of Analytics in a moment of frustration. She immediately regretted it.", "plaintiffsPerformance": "Clark was a solid employee for 20+ years. His reviews slipped from 'Meets Expectations' to 'Needs Improvement' over the last three years. He was on a Performance Improvement Plan (PIP) for 6 months prior to termination, which the company claims he failed.", "inconsistenciesAndEvasions": { "onTheRemark": "Will be evasive about age-related comments. If confronted with the specific quote, she will deny it, then fall back to the 'stray remark' defense.", "onYoungerEmployees": "Will be reluctant to discuss the performance of younger employees who replaced some of Clark's functions, claiming confidentiality. (Fact: A junior analyst, 32, who took over some duties also missed a deadline last quarter, a fact Susan will not volunteer)." } } }
            ];

            let appState = {
                providerId: 'openai', apiKey: '', model: '', isJudgePresent: false, isOocMode: false, caseData: null, witnesses: [], activeWitnessIndex: 0, messages: [], isLoading: false, totalTokens: 0, totalCost: 0.0
            };

 const PROVIDERS = {
    openai: {
        label: "OpenAI",
        models: [
            { name: "gpt-4o-mini", pricing: { inputPerMillionTokens: 0.15, outputPerMillionTokens: 0.60 } },
            { name: "gpt-4o", pricing: { inputPerMillionTokens: 5.00, outputPerMillionTokens: 15.00 } }
        ],
        defaultModel: "gpt-4o-mini",
        chat: async ({ apiKey, model, messages }) => {
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}` },
                body: JSON.stringify({ model, messages }),
            });
            if (!response.ok) throw new Error(`OpenAI API request failed: ${response.statusText}`);
            const data = await response.json();
            return {
                message: data.choices[0].message,
                usage: { inputTokens: data.usage.prompt_tokens, outputTokens: data.usage.completion_tokens }
            };
        },
    },
    gemini: {
        label: "Google Gemini",
        // Using the model names as you specified.
        models: [
            { name: "gemini-2.5-flash", pricing: { inputPerMillionTokens: 0.35, outputPerMillionTokens: 0.70 } },
            { name: "gemini-2.5-pro", pricing: { inputPerMillionTokens: 3.50, outputPerMillionTokens: 10.50 } }
        ],
        defaultModel: "gemini-2.5-flash",
        chat: async ({ apiKey, model, messages }) => {
            const formattedMessages = messages.filter(m => m.role !== 'system').map(m => ({
                role: m.role === 'assistant' ? 'model' : m.role,
                parts: [{ text: m.content }]
            }));
            const systemInstruction = messages.find(m => m.role === 'system');
            const body = {
                contents: formattedMessages,
                ...(systemInstruction && { systemInstruction: { parts: [{ text: systemInstruction.content }] } })
            };
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            // FIXED: This enhanced error handling provides specific, actionable diagnostics from the API.
            if (!response.ok) {
                let errorMsg = `API request failed with status ${response.status}.`;
                try {
                    const errorBody = await response.json();
                    if (errorBody && errorBody.error && errorBody.error.message) {
                        // Provides the exact error message from the Gemini API.
                        errorMsg = `[${response.status}] ${errorBody.error.message}`;
                    }
                } catch (e) {
                    errorMsg += " Could not parse error response from API.";
                }
                throw new Error(errorMsg);
            }

            const data = await response.json();

            // FIXED: Added check for empty or blocked API responses.
            if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                let reason = "The model returned an empty response.";
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    reason = `Content was blocked by safety settings: ${data.promptFeedback.blockReason}.`;
                } else if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason) {
                    reason = `Generation stopped unexpectedly. Reason: ${data.candidates[0].finishReason}.`;
                }
                throw new Error(reason);
            }

            const usage = data.usageMetadata || { promptTokenCount: 0, candidatesTokenCount: 0 };
            
            // FIXED: The returned message object now matches the structure the app expects.
            return {
                message: {
                    role: 'assistant',
                    content: data.candidates[0].content.parts[0].text
                },
                usage: { 
                    inputTokens: usage.promptTokenCount, 
                    outputTokens: usage.candidatesTokenCount
                }
            };
        },
    },
};

            const dom = {
                providerSelect: document.getElementById('provider'), apiKeyInput: document.getElementById('apiKey'), modelSelect: document.getElementById('model'),
                judgeModeCheckbox: document.getElementById('judgeMode'), fileLoaderInput: document.getElementById('fileLoader'), scenarioSelector: document.getElementById('scenarioSelector'),
                witnessSelectorCard: document.getElementById('witnessSelectorCard'), witnessSelector: document.getElementById('witnessSelector'), intelCard: document.getElementById('intelCard'),
                summaryDetailSlider: document.getElementById('summaryDetailSlider'), getSummaryButton: document.getElementById('getSummaryButton'), chatTitle: document.getElementById('chat-title'),
                chatHistory: document.getElementById('chat-history'), modeToggleCheckbox: document.getElementById('modeToggleCheckbox'), chatInput: document.getElementById('chatInput'),
                sendButton: document.getElementById('sendButton'), saveTranscriptButton: document.getElementById('saveTranscriptButton'), totalTokensSpan: document.getElementById('totalTokens'),
                estimatedCostSpan: document.getElementById('estimatedCost')
            };

            function getActiveWitness() { return appState.witnesses[appState.activeWitnessIndex] || null; }
            function buildDepositionPrompt(w, j) { if (!w) return { role: "system", content: "Error: No witness data." }; const wt = JSON.stringify(w, null, 2); const ji = j ? `A judge IS present. After an objection, you MUST rule on it as THE JUDGE (e.g., "Sustained." or "Overruled."). If overruled, THE WITNESS must answer.` : `A judge is NOT present. You must NOT act as a judge. After a form objection, THE WITNESS should still answer.`; const dli = `**Role of OPPOSING COUNSEL (Defending Lawyer):** Your primary goal is to protect your client and the record.\n1.  **Form Objections:** For questions that are leading, compound, or assume facts, state the objection for the record (e.g., "Objection, form."), but then allow the witness to answer.\n2.  **Privilege Objections (CRITICAL):** If a question asks about communications between the witness and their attorney, you MUST object and instruct the witness not to answer. Format: "Objection, attorney-client privilege. I'm instructing the witness not to answer." THE WITNESS must then refuse to answer. This is the main reason to instruct a witness not to answer.`; return { role: "system", content: `You are an AI performing roles in a legal deposition.\n\n**Roles & Rules:**\n1.  **THE WITNESS:** Your primary role, defined by the JSON below. Stay in character.\n2.  **OPPOSING COUNSEL:** You must also act as the witness's lawyer. ${dli}\n3.  **THE JUDGE:** ${ji}\n\n**Execution:** Never mention you are an AI. You ARE the people you are portraying. Uphold all concealment motivations from the JSON unless a question forces a direct answer.\n\n**Witness Dossier:**\n\`\`\`json\n${wt}\n\`\`\`` }; }
            function buildOocPrompt(w, h) { const ht = h.slice(1).map(m => `${m.role === 'user' ? 'Examiner' : (m.isOoc ? 'Coach' : 'Witness')}: ${m.content}`).join('\n'); return { role: "system", content: `You are an expert deposition coach AI. The user is in "Coach Mode" and needs out-of-character help. Your persona is a helpful law professor.\n\n**CRITICAL:** You must BREAK CHARACTER from the witness/lawyer persona. DO NOT answer in character.\n\nAnalyze the user's latest question based on the full deposition history provided below. Provide a helpful, meta-level response. Give hints, suggest better questions, or explain legal concepts.\n\n**Deposition History:**\n${ht}\n\n**Witness Dossier for Context:**\n\`\`\`json\n${JSON.stringify(w, null, 2)}\n\`\`\`` }; }
            function buildSummaryPrompt(w, d) {
    const dm = { 1: "a brief one-paragraph summary", 2: "a moderate summary with bullet points", 3: "a detailed summary" };
    const di = dm[d];
    const pi = { "Witness Name": w?.name || w?.witnessBackground?.personalDetails?.fullName, "Basic Details": { Age: w?.witnessBackground?.personalDetails?.age, Occupation: w?.witnessBackground?.personalDetails?.occupation, Residence: w?.witnessBackground?.personalDetails?.residence, }, "Professional Reputation": w?.witnessBackground?.professionalLife?.reputation, "Official Statement Summary": w?.fullWitnessInformation?.officialStatementSummary };
    Object.keys(pi).forEach(k => (pi[k] === undefined || pi[k] === null) && delete pi[k]);
    if(pi["Basic Details"]){ Object.keys(pi["Basic Details"]).forEach(k => (pi["Basic Details"][k] === undefined || pi["Basic Details"][k] === null) && delete pi["Basic Details"][k]); }
    return {
        role: "user", // <-- This is the only line that has changed
        content: `You are a legal assistant providing a pre-deposition briefing. Based ONLY on the following pre-vetted information, provide ${di}. Do not infer or add any information not present below. Do not provide analysis or advice.\n\n**Vetted Witness Information:**\n\`\`\`json\n${JSON.stringify(pi, null, 2)}\n\`\`\``
    };
}

            function renderProviderOptions() { dom.providerSelect.innerHTML = ''; for (const [id, p] of Object.entries(PROVIDERS)) { const o = document.createElement('option'); o.value = id; o.textContent = p.label; dom.providerSelect.appendChild(o); } }
            function renderModelOptions() { const p = PROVIDERS[appState.providerId]; dom.modelSelect.innerHTML = ''; p.models.forEach(m => { const o = document.createElement('option'); o.value = m.name; o.textContent = m.name; dom.modelSelect.appendChild(o); }); appState.model = p.defaultModel; dom.modelSelect.value = p.defaultModel; }
            function renderChatMessages() { dom.chatHistory.innerHTML = ''; appState.messages.slice(1).forEach(m => { const wr = document.createElement('div'); wr.className = 'message-wrapper'; const md = document.createElement('div'); md.className = 'chat-message'; if (m.isOoc) { md.classList.add('meta-message'); } else { md.classList.add(m.role === 'user' ? 'user-message' : 'assistant-message'); } md.textContent = m.content; wr.appendChild(md); dom.chatHistory.appendChild(wr); }); if (appState.isLoading) { const ti = document.createElement('div'); ti.className = 'typing-indicator assistant-message'; ti.textContent = 'Typing...'; dom.chatHistory.appendChild(ti); } dom.chatHistory.scrollTop = dom.chatHistory.scrollHeight; }
            function renderCost() { dom.totalTokensSpan.textContent = appState.totalTokens.toLocaleString(); dom.estimatedCostSpan.textContent = `$${appState.totalCost.toFixed(6)}`; }
            function updateUI() { const w = getActiveWitness(); const i = w !== null; const h = appState.messages.length > 1; dom.intelCard.style.display = i ? 'block' : 'none'; dom.chatInput.disabled = !i || appState.isLoading; dom.sendButton.disabled = !i || appState.isLoading; dom.modeToggleCheckbox.disabled = !i || appState.isLoading; dom.saveTranscriptButton.disabled = !i || appState.isLoading || !h; dom.getSummaryButton.disabled = !i || appState.isLoading; dom.chatInput.placeholder = appState.isOocMode ? "Ask for a hint or feedback..." : (i ? "Type your question..." : "Choose or upload a scenario to begin..."); if (w) { const wn = w.name || w?.witnessBackground?.personalDetails?.fullName || 'Unnamed Witness'; dom.chatTitle.textContent = `Deposition of: ${wn}`; } else { dom.chatTitle.textContent = 'Deposition'; } }
            function resetChat() { const w = getActiveWitness(); appState.messages = w ? [buildDepositionPrompt(w, appState.isJudgePresent)] : []; appState.totalTokens = 0; appState.totalCost = 0.0; renderCost(); renderChatMessages(); updateUI(); }

            function updateCost(u) { const p = PROVIDERS[appState.providerId]; const m = p.models.find(mod => mod.name === appState.model); if (!m || !u) return; const iC = (u.inputTokens / 1000000) * m.pricing.inputPerMillionTokens; const oC = (u.outputTokens / 1000000) * m.pricing.outputPerMillionTokens; appState.totalTokens += (u.inputTokens + u.outputTokens); appState.totalCost += (iC + oC); renderCost(); }
            function handleSaveTranscript() { const w = getActiveWitness(); if (!w) return; const wn = w.name || w?.witnessBackground?.personalDetails?.fullName || 'Unnamed Witness'; const t = new Date().toISOString().slice(0, 10); let tc = `# Deposition Transcript\n\n- **Witness:** ${wn}\n- **Date:** ${t}\n- **LLM Provider:** ${PROVIDERS[appState.providerId].label}\n- **LLM Model:** ${appState.model}\n---\n\n`; appState.messages.slice(1).forEach(m => { let s = ""; if (m.role === 'user') s = "Examiner"; else if (m.isOoc) s = "Coach"; else s = "Witness"; tc += `**${s}:** ${m.content}\n\n`; }); const b = new Blob([tc], { type: 'text/markdown' }); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = `Deposition-of-${wn.replace(/\s+/g, '_')}-${t}.md`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); }
            async function handleSendMessage() { const q = dom.chatInput.value.trim(); if (!q || appState.isLoading) return; const um = { role: 'user', content: q, isOoc: appState.isOocMode }; let tp; if (appState.isOocMode) { tp = buildOocPrompt(getActiveWitness(), appState.messages); } else { tp = buildDepositionPrompt(getActiveWitness(), appState.isJudgePresent); } const am = [tp, ...appState.messages.slice(1), um]; appState.messages.push(um); appState.isLoading = true; renderChatMessages(); updateUI(); dom.chatInput.value = ''; dom.chatInput.style.height = 'auto'; try { if (!appState.apiKey) throw new Error("API Key is missing."); const { message, usage } = await PROVIDERS[appState.providerId].chat({ apiKey: appState.apiKey, model: appState.model, messages: am }); message.isOoc = appState.isOocMode; appState.messages.push(message); updateCost(usage); } catch (e) { console.error("API Error:", e); appState.messages.push({ role: 'assistant', content: `Error: ${e.message}`, isOoc: true }); } finally { appState.isLoading = false; renderChatMessages(); updateUI(); } }
            async function handleGetSummary() { const w = getActiveWitness(); if (!w || appState.isLoading) return; const dl = dom.summaryDetailSlider.value; const sp = buildSummaryPrompt(w, dl); appState.isLoading = true; renderChatMessages(); updateUI(); try { if (!appState.apiKey) throw new Error("API Key is missing."); const { message, usage } = await PROVIDERS[appState.providerId].chat({ apiKey: appState.apiKey, model: appState.model, messages: [sp] }); message.isOoc = true; appState.messages.push(message); updateCost(usage); } catch (e) { console.error("API Error:", e); appState.messages.push({ role: 'assistant', content: `Error: ${e.message}`, isOoc: true }); } finally { appState.isLoading = false; renderChatMessages(); updateUI(); } }
            function loadWitnessData(data) { appState.caseData = data; if (Array.isArray(data.witnesses)) { appState.witnesses = data.witnesses; dom.witnessSelector.innerHTML = ''; appState.witnesses.forEach((w, i) => { const o = document.createElement('option'); o.value = i; o.textContent = w.name || w?.witnessBackground?.personalDetails?.fullName || `Witness ${i + 1}`; dom.witnessSelector.appendChild(o); }); dom.witnessSelectorCard.style.display = 'block'; } else { appState.witnesses = [data]; dom.witnessSelectorCard.style.display = 'none'; } appState.activeWitnessIndex = 0; resetChat(); }
            
            dom.providerSelect.addEventListener('change', (e) => { appState.providerId = e.target.value; renderModelOptions(); });
            dom.apiKeyInput.addEventListener('change', (e) => { appState.apiKey = e.target.value; localStorage.setItem(`llm_${appState.providerId}_key`, appState.apiKey); });
            dom.modelSelect.addEventListener('change', (e) => { appState.model = e.target.value; });
            dom.judgeModeCheckbox.addEventListener('change', (e) => { appState.isJudgePresent = e.target.checked; });
            dom.fileLoaderInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const p = JSON.parse(ev.target.result); loadWitnessData(p); dom.scenarioSelector.value = "-1"; } catch (err) { alert("Invalid JSON file."); console.error("JSON Parse Error:", err); } }; r.readAsText(f); });
            dom.scenarioSelector.addEventListener('change', (e) => { const index = parseInt(e.target.value, 10); if (index >= 0) { loadWitnessData(PRE_BUILT_SCENARIOS[index]); dom.fileLoaderInput.value = ""; } });
            
            if (dom.witnessSelector) {
                dom.witnessSelector.addEventListener('change', (e) => { appState.activeWitnessIndex = Number(e.target.value); resetChat(); });
            }
            
            dom.modeToggleCheckbox.addEventListener('change', (e) => { appState.isOocMode = e.target.checked; updateUI(); });
            dom.getSummaryButton.addEventListener('click', handleGetSummary);
            dom.chatInput.addEventListener('input', () => { dom.chatInput.style.height = 'auto'; dom.chatInput.style.height = (dom.chatInput.scrollHeight) + 'px'; });
            dom.sendButton.addEventListener('click', handleSendMessage);
            dom.saveTranscriptButton.addEventListener('click', handleSaveTranscript);
            dom.chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });

            function initialize() {
                renderProviderOptions();
                const defaultProviderId = dom.providerSelect.value || 'openai';
                appState.providerId = defaultProviderId;
                appState.apiKey = localStorage.getItem(`llm_${defaultProviderId}_key`) || '';
                dom.apiKeyInput.value = appState.apiKey;
                renderModelOptions();
                updateUI();
            }

            initialize();
        });
    </script>
</body>
</html>
